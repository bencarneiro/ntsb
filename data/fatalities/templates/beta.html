<!DOCTYPE html>
<html>
    <head>
        <title>Roadway Fatalities 2001-2022</title>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="static/css/maplibre-gl.css">
        <script src="static/js/maplibre-gl.js"></script>
        <script src="static/js/pmtiles.js"></script>
        <style>
            body {
                margin: 0;
            }
            html, body, #map {
                height:100%; width:100%;
            }
            .popup .maplibregl-popup-content {
                max-height: 50vh;
                overflow-y: auto;
            }
            h1 {
            font-family: Arial, Helvetica, sans-serif;
            text-align: center;
            font-size: 4rem;
            }
            h2 {
            font-family: Arial, Helvetica, sans-serif;
            text-align: center;
            font-size: 2rem;
            }
            .table{
            font-family: Arial, Helvetica, sans-serif;
            border-collapse: collapse;
            margin-left: auto;
            margin-right: auto
            }
            td, th {
            border: 1px solid #ddd;
            padding: 8px;
            width: 50%;
            text-align: center;
            align-items: center;
            position: center;
            }
            .dt {
                width:20%;
                text-wrap: wrap;
                word-break: break-word;
            }
    .map-overlay {
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        position: absolute;
        width: 200px;
        top: 0;
        left: 0;
        padding: 10px;
    }

    .map-overlay .map-overlay-inner {
        background-color: #fff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        border-radius: 3px;
        padding: 10px;
        margin-bottom: 10px;
    }

    .map-overlay-inner fieldset {
        border: none;
        padding: 0;
        margin: 0 0 10px;
    }

    .map-overlay-inner fieldset:last-child {
        margin: 0;
    }

    .map-overlay-inner select {
        width: 100%;
    }

    .map-overlay-inner label {
        display: block;
        font-weight: bold;
        margin: 0 0 5px;
    }

    .map-overlay-inner button {
        display: inline-block;
        width: 36px;
        height: 20px;
        border: none;
        cursor: pointer;
    }

    .map-overlay-inner button:focus {
        outline: none;
    }

    .map-overlay-inner button:hover {
        box-shadow: inset 0 0 0 3px rgba(0, 0, 0, 0.1);
    }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <div class="map-overlay top">
            <div class="map-overlay-inner">
                <fieldset>
                    <label for="layer">Select layer</label>
                    <select id="layer" name="layer">
                        <option value="all">All Roadway Deaths</option>
                        <option value="vehicle">Driver / Passenger Deaths</option>
                        <option value="nonmotorist">Pedestrian / Bike / Other Deaths</option>
                    </select>
                </fieldset>
            </div>
        </div>
        <script type="text/javascript">
            let menu = document.getElementById('layer')
            menu.addEventListener("change", function(e) {
                console.log(e.target.value)

                map.getStyle().layers.forEach((layer) => {
                    console.log(layer)
                    if(layer.id != "base-raster"){
                        map.removeLayer(layer.id);
                        map.removeSource(layer.id);
                        }
                    });

                for (i = 2001; i < 2023; i++) {

                    var layerName
                    var sourceUrl
                    if (e.target.value == "all") {
                        console.log("ALL")
                        layerName = `total_fatalities_${i}`
                        sourceUrl =  `pmtiles://static/tiles/total_tiles/${i}.pmtiles`
                    }
                    if (e.target.value == "vehicle") {
                        console.log("VEHICLE")
                        layerName = `vehicle_fatalities_${i}`
                        sourceUrl =  `pmtiles://static/tiles/vehicle_tiles/${i}.pmtiles`
                    }
                    if (e.target.value == "nonmotorist") {
                        console.log("NONMOTORIST")
                        layerName = `nonmotorist_fatalities_${i}`
                        sourceUrl =  `pmtiles://static/tiles/nonmotorist_tiles/${i}.pmtiles`
                    }

                    map.addLayer({
                        id: layerName,
                        type: "circle",
                        source: {
                            url: sourceUrl,
                            type: "vector"
                        },
                        "source-layer": layerName,
                        paint: {
                            "circle-opacity": .3,
                            "circle-color": "darkred",
                            "circle-radius": [
                                "interpolate", ["exponential", 1.1], ["zoom"],
                                2, .3,
                                14, 5
                            ],
                            "circle-stroke-opacity": .6,
                            "circle-stroke-color": "darkred",
                            "circle-stroke-width": [
                                "interpolate", ["exponential", 1.1], ["zoom"],
                                2, 0,
                                14, 1
                            ],
                        }
                    })
                    map.on('mouseenter', `${i}`, () => {map.getCanvas().style.cursor = 'pointer'});
                    map.on('mouseleave', `${i}`, () => {map.getCanvas().style.cursor = ''});
                }
            })
            let protocol = new pmtiles.Protocol();
            maplibregl.addProtocol("pmtiles", protocol.tile);

            var map = new maplibregl.Map({
                container: 'map',
                style: {
                    version: 8,
                    sources: {
                        "base-raster": {
                            type: "raster",
                            tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
                            tileSize: 256,
                            attribution: "<a href='/info' target='_blank'>MORE ABOUT ROADWAY.REPORT</a>"
                        }
                    },
                    layers: [
                        {
                            id: "base-raster",
                            type: "raster",
                            source: "base-raster",
                            paint: {
                                "raster-saturation": -1,
                            }
                        }
                    ]
                },
                center: [-120, 45],
                zoom: 3
            });
            map.addControl(
                new maplibregl.GeolocateControl({
                    positionOptions: {
                        enableHighAccuracy: true
                    },
                    trackUserLocation: true
                })
            );   
            // https://hotgarbo.github.io/nhtsa-fars/tiles/2018.pmtiles
            map.on('load', () => {
                for (i = 2001; i < 2023; i++) {
                    map.addLayer({
                        id: `total_fatalities_${i}`,
                        type: "circle",
                        source: {
                            url: `pmtiles://static/tiles/total_tiles/${i}.pmtiles`,
                            type: "vector"
                        },
                        "source-layer": `total_fatalities_${i}`,
                        paint: {
                            "circle-opacity": .3,
                            "circle-color": "darkred",
                            "circle-radius": [
                                "interpolate", ["exponential", 1.1], ["zoom"],
                                2, .3,
                                14, 5
                            ],
                            "circle-stroke-opacity": .6,
                            "circle-stroke-color": "darkred",
                            "circle-stroke-width": [
                                "interpolate", ["exponential", 1.1], ["zoom"],
                                2, 0,
                                14, 1
                            ],
                        }
                    })
                    map.on('mouseenter', `${i}`, () => {map.getCanvas().style.cursor = 'pointer'});
                    map.on('mouseleave', `${i}`, () => {map.getCanvas().style.cursor = ''});
                }
                map.on('click', (e) => {
                    const features = map.queryRenderedFeatures(e.point);
                    if (features.length == 0) return;
                    let table = "<table><thead><tr><th>Date</th><th>Deaths</th><th></th></tr></thead>";
                    let total = 0;
                    features.forEach((f, i) => {
                        table += "<tr>";
                        let date = new Date(f.properties.year, f.properties.month-1, f.properties.day);
                        table += `<tr><td>${date.toDateString()}</td>`;
                        let deaths = f.properties.fatalities;
                        total += deaths;
                        table += `<td align='right'>${deaths}</td>`;
                        let id = `${f.properties.year}${String(f.properties.st_case).padStart(6, "0")}`;
                        table += `<td><a href="https://roadway.report/accidents/${id}" target="_blank">Details</a></td>`;
                        table += "</tr>";
                    })
                    table += "</table>";
                    let header = `<h2>${total} Death${total > 1 ? 's' : ''}</h2>`;
                    new maplibregl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(header + table)
                        .addTo(map)
                        .addClassName("popup");
                });
            });
        </script>
    </body>
</html>

